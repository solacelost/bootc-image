#!/bin/bash

trap 'echo -e "Failed, exit code: $?\nExiting early"; exit 0' ERR

function noisy {
    set -x
    "${@}"
    { set +x; } 2>/dev/null
}

function register {
    proton_dist="$1"
    dest_pfx="$2"
    if [ ! -e "$dest_pfx" ]; then
        echo "No prefix exists - has game been launched yet?" >&2
        false
    fi
    dest="$dest_pfx/drive_c/windows/system32"
    cp -uv /usr/lib/wine/i386-windows/wineasio32.dll "$dest/"
    cp -uv /usr/lib64/wine/x86_64-windows/wineasio64.dll "$dest/"
    noisy env WINEPREFIX="$dest_pfx" "$proton_dist/bin/wine" regsvr32 /s /usr/lib/wine/i386-unix/wineasio32.dll.so
    noisy env WINEPREFIX="$dest_pfx" "$proton_dist/bin/wine64" regsvr32 /s /usr/lib64/wine/x86_64-unix/wineasio64.dll.so
}

wineasio_dlls=(
    i386-unix/wineasio32.dll.so
    i386-windows/wineasio32.dll
    x86_64-unix/wineasio64.dll.so
    x86_64-windows/wineasio64.dll
)

while IFS= read -r -d '' proton; do
    for dll in "${wineasio_dlls[@]}"; do
        src="/usr/lib/wine/$dll"
        dest="$proton/lib/wine/$dll"
        if [ -e "$src" ]; then
            mkdir -p "$(dirname "$dest")"
            cp -uv "$src" "$dest"
        fi
    done
done < <(/usr/local/bin/list-protons.py)

declare -A desired_prefixes
desired_prefixes=(
    [221680]="RocksmithÂ® 2014 Edition - Remastered"
)

for game_id in "${!desired_prefixes}"; do
    prefix="$(/usr/local/bin/prefix-for-game.py --id "$game_id")"
    if [[ " ${!desired_prefixes[*]} " =~ [[:space:]]${game_id}[[:space:]] ]]; then
        proton_dist="$(/usr/local/bin/proton-for-game.py --id "$game_id")"
        register "$proton_dist" "$prefix"
    fi
done
