#!/bin/bash

main_monitor=DP-3
small_monitor=HDMI-A-1

function _xrandr_fix {
    sleep 0.1
    primary=$(xrandr | awk '/^[^ ].*3440x1440/{print $1}')
    xrandr --output $primary --primary
}

function _monitors_off {
    swaymsg output $small_monitor disable
    swaymsg output $main_monitor disable
    sleep 0.1
}

entries="
Sideways,
Wide,
Single,
Alternate,
AlternatePortrait"

default=Wide

statefile=${XDG_RUNTIME_DIR:-/run/user/${UID:-1000}}/monitorswap

current=$(cat $statefile 2>/dev/null || :)
echo "current layout: $current" >&2

if [ "$1" = "reload" ]; then
    echo "reload requested, blanking first" >&2
    selected=${current:-$default}
    _monitors_off
elif [ "$1" ]; then
    selected="$1"
else
    selected=$(echo $entries | rofi -m -1 -dmenu -sep ',' -p "monitor setup" -i)
fi
selected=$(echo "$selected" | tr 'A-Z' 'a-z' | tr -d ' ')

if [ "$current" = "$selected" ] && [ "$1" != "reload" ]; then
    echo "not changing" >&2
    # no need to change
    exit 0
fi
echo "selected layout: $selected" >&2

function _single_monitor {
    set -x
    swaymsg output $main_monitor enable pos 0 0 adaptive_sync on mode 3440x1440@143.923Hz
    swaymsg output $small_monitor disable
    echo single >$statefile
}

function _alternate_monitor {
    set -x
    swaymsg output $main_monitor disable
    swaymsg output $small_monitor enable pos 0 0 adaptive_sync on transform 0 mode 1920x1080@60.000Hz
    echo alternate >$statefile
}

function _alternate_portrait_monitor {
    set -x
    swaymsg output $main_monitor disable
    swaymsg output $small_monitor enable pos 0 0 adaptive_sync on transform 270 mode 1920x1080@60.000Hz
    echo alternateportrait >$statefile
}

function _sideways_monitor {
    set -x
    swaymsg output $main_monitor enable pos 1080 240 adaptive_sync on mode 3440x1440@120.000Hz
    swaymsg output $small_monitor enable pos 0 0 adaptive_sync on transform 270 mode 1920x1080@60.000Hz
    echo sideways >$statefile
}

function _wide_monitor {
    set -x
    swaymsg output $main_monitor enable pos 1920 0 adaptive_sync on mode 3440x1440@143.923Hz
    swaymsg output $small_monitor enable pos 0 180 adaptive_sync on transform 0 mode 1920x1080@60.000Hz
    echo wide >$statefile
}

case $selected in
single)
    _single_monitor
    ;;
alternate)
    _alternate_monitor
    ;;
sideways)
    _sideways_monitor
    ;;
wide)
    _wide_monitor
    ;;
alternateportrait)
    _alternate_portrait_monitor
    ;;
*)
    echo "Unknown option: $selected. Options:" >&2
    echo "$entries" >&2
    exit 1
    ;;
esac
