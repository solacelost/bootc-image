#!/bin/bash -e

camera_name="Canon_EOS_Rebel_T7"
camera_device=04a9:32e1

capture_running() {
    ps -elf | grep -qF -- 'gphoto2 --stdout --capture-movie'
}
camera_plugged_in() {
    lsusb -d $camera_device >/dev/null 2>&1
}
capture() {
    set -x
    gphoto2 --stdout --capture-movie | ffmpeg \
        -hwaccel vaapi \
        -c:v mjpeg \
        -i - \
        -vcodec rawvideo \
        -pix_fmt yuv420p \
        -threads 2 \
        -f v4l2 $device
    { set +x; } 2>/dev/null
}

# Save the device name of the camera after following all the logic
device=$(v4l2loopback-ctl list 2>/dev/null | awk "/$camera_name/{print $1}")

was_plugged=false

echo "Waiting for device $camera_device"
while :; do
    while camera_plugged_in; do
        echo "Device $camera_device was plugged in"
        was_plugged=true
        if ! capture_running; then
            capture && continue || :
        fi
        sleep 1
    done
    if $was_plugged; then
        echo "Device $camera_device was unplugged"
        was_plugged=false
    fi
    sleep 3
done
