#!/bin/bash -e

camera_name="Canon EOS Rebel T7"
camera_device=04a9:32e1

capture_running() {
    ps -elf | grep -q -- '[g]photo2 --stdout --capture-movie'
}
camera_plugged_in() {
    lsusb -d $camera_device >/dev/null 2>&1
}
capture() {
    gphoto2 --stdout --capture-movie | ffmpeg -vaapi_device /dev/dri/renderD128 -vcodec rawvideo -pix_fmt yuv420p -threads:v 1 -filter_threads 1 -i - -vf 'format=nv12,hwupload' -c:v mjpeg_vaapi -f v4l2 -c copy $device
}

# Save the device name of the camera after following all the logic
device=$(v4l2loopback-ctl list 2>/dev/null | awk "/$camera_name/{print $1}")

was_plugged=false

echo "Waiting for device $camera_device"
while :; do
    while camera_plugged_in; do
        echo "Device $camera_device was plugged in"
        was_plugged=true
        if ! capture_running; then
            capture && continue || :
        fi
        sleep 1
    done
    if $was_plugged; then
        echo "Device $camera_device was unplugged"
        was_plugged=false
    fi
    sleep 3
done
